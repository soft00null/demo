// controllers/webhookController.js
const admin = require('firebase-admin');
const fs = require('fs');
const path = require('path');

// Firebase Service Imports
const {
  ensureCitizenExists,
  getCitizenBotMode,
  saveChatMessage,
  updateCitizenEthicalScore,
  checkDuplicateComplaint,
  createDraftComplaint,
  confirmComplaint,
  cancelComplaint,
  getConversationContext,
  getMediaUrl,
  downloadAndUploadImage,
  geocodeAddress,
  sanitizeFirestoreData
} = require('../services/firebaseService');

// WhatsApp Service Imports
const {
  sendTextMessage,
  sendQuickReply,
  sendLocationRequest,
  sendListMessage,
  markMessageAsRead,
} = require('../services/whatsappService');

// AI Service Imports
const {
  processMessageWithAI,
  analyzeIntent,
  calculateEthicalScore,
  transcribeAudio,
  analyzeImageContent,
  detectLanguage
} = require('../services/aiService');

// Utility Imports
const { generateTicketId, sanitizeInput, formatPhoneNumber } = require('../utils/helpers');
const { downloadAudioFile } = require('../utils/mediaHandlers');
const logger = require('../utils/logger');

/**
 * Main webhook handler for WhatsApp Cloud API
 */
async function handleWebhook(req, res) {
  const startTime = Date.now();
  logger.webhook('üì• Webhook request received', {
    method: req.method,
    contentType: req.get('Content-Type'),
    bodySize: JSON.stringify(req.body).length,
    userAgent: req.get('User-Agent'),
    ip: req.ip,
    timestamp: new Date().toISOString()
  });

  try {
    const body = req.body;
    
    // Validate webhook payload structure
    if (!body || typeof body !== 'object') {
      logger.warning('‚ùå Invalid webhook payload - not an object', { body });
      return res.sendStatus(400);
    }
    
    // Validate webhook object type
    if (!body.object || body.object !== 'whatsapp_business_account') {
      logger.warning('‚ùå Invalid webhook object received', { 
        object: body.object,
        expectedObject: 'whatsapp_business_account',
        receivedKeys: Object.keys(body)
      });
      return res.sendStatus(404);
    }

    logger.webhook('‚úÖ Valid WhatsApp webhook payload received');

    // Handle incoming messages
    if (body.entry?.[0]?.changes?.[0]?.value?.messages) {
      logger.webhook('üì® Processing incoming message');
      await processIncomingMessage(body);
      const processingTime = Date.now() - startTime;
      logger.webhook(`‚úÖ Message processed successfully in ${processingTime}ms`);
      return res.sendStatus(200);
    }

    // Handle message status updates
    if (body.entry?.[0]?.changes?.[0]?.value?.statuses) {
      logger.webhook('üìä Processing message status update');
      await processMessageStatus(body);
      logger.webhook('‚úÖ Status update processed');
      return res.sendStatus(200);
    }

    // Handle other webhook events
    if (body.entry?.[0]?.changes?.[0]?.field) {
      const field = body.entry[0].changes[0].field;
      logger.webhook(`‚ÑπÔ∏è Webhook event for field: ${field}`, { field });
      return res.sendStatus(200);
    }

    // Default response for unhandled webhooks
    logger.webhook('‚ÑπÔ∏è Unhandled webhook payload received', { 
      hasEntry: !!body.entry,
      hasChanges: !!body.entry?.[0]?.changes,
      hasValue: !!body.entry?.[0]?.changes?.[0]?.value,
      bodyStructure: Object.keys(body)
    });
    res.sendStatus(200);

  } catch (error) {
    const processingTime = Date.now() - startTime;
    logger.critical('üí• Error in webhook handler', {
      error: error.message,
      stack: error.stack,
      processingTime,
      bodyKeys: Object.keys(req.body || {}),
      url: req.url,
      method: req.method
    });
    res.sendStatus(500);
  }
}

/**
 * Process incoming messages based on type
 */
async function processIncomingMessage(body) {
  const messageStartTime = Date.now();
  
  try {
    const messageData = body.entry[0].changes[0].value;
    const message = messageData.messages[0];
    const contact = messageData.contacts?.[0];
    const metadata = messageData.metadata;

    const phoneNumber = formatPhoneNumber(message.from);
    const displayName = contact?.profile?.name || 'Unknown User';
    const messageType = message.type;
    const messageId = message.id;
    const timestamp = message.timestamp;

    logger.citizen('üë§ New message from citizen', {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      displayName,
      messageType,
      messageId,
      timestamp: new Date(parseInt(timestamp) * 1000).toISOString()
    });

    // Log message content preview based on type
    let contentPreview = '';
    switch (messageType) {
      case 'text':
        contentPreview = message.text?.body?.substring(0, 100) + '...';
        logger.debug('üìù Text message content', {
          contentPreview,
          contentLength: message.text?.body?.length || 0
        });
        break;
      case 'audio':
        logger.debug('üéµ Audio message received', {
          mediaId: message.audio?.id,
          mimeType: message.audio?.mime_type
        });
        break;
      case 'image':
        logger.debug('üñºÔ∏è Image message received', {
          mediaId: message.image?.id,
          caption: message.image?.caption || 'No caption'
        });
        break;
      case 'location':
        logger.debug('üìç Location message received', {
          latitude: message.location?.latitude,
          longitude: message.location?.longitude,
          name: message.location?.name
        });
        break;
      case 'interactive':
        logger.debug('üîò Interactive message received', {
          type: message.interactive?.type,
          buttonId: message.interactive?.button_reply?.id
        });
        break;
      default:
        logger.debug(`üìÑ ${messageType} message received`);
    }

    // Ensure citizen exists in database
    logger.firebase('Ensuring citizen exists in database...');
    await ensureCitizenExists(phoneNumber, displayName);

    // Mark message as read
    logger.whatsapp('Marking message as read...');
    await markMessageAsRead(messageId);

    // Route to appropriate handler based on message type
    logger.debug(`üîÑ Routing to ${messageType} message handler`);
    
    switch (messageType) {
      case 'text':
        await handleTextMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'audio':
        await handleAudioMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'image':
        await handleImageMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'location':
        await handleLocationMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'interactive':
        await handleInteractiveMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'document':
        await handleDocumentMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'video':
        await handleVideoMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'sticker':
        await handleStickerMessage(message, phoneNumber, displayName, messageId);
        break;
      case 'contacts':
        await handleContactMessage(message, phoneNumber, displayName, messageId);
        break;
      default:
        logger.warning(`‚ùì Unsupported message type: ${messageType}`);
        await sendUnsupportedMessageResponse(phoneNumber, messageType);
    }

    const processingTime = Date.now() - messageStartTime;
    logger.success(`Message processing completed in ${processingTime}ms`, {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      messageType,
      processingTime
    });

  } catch (error) {
    const processingTime = Date.now() - messageStartTime;
    logger.critical('üí• Error processing incoming message', {
      error: error.message,
      stack: error.stack,
      processingTime,
      messageData: body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]?.type || 'unknown'
    });
    
    // Try to send error message to user if we have phone number
    try {
      const phoneNumber = formatPhoneNumber(body.entry[0].changes[0].value.messages[0].from);
      await sendTextMessage(phoneNumber, 
        '‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, ‡§§‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä ‡§Ü‡§π‡•á. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡•ã‡§°‡•ç‡§Ø‡§æ ‡§µ‡•á‡§≥‡§æ‡§®‡•á ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.\n\nSorry, there was a technical issue. Please try again in a moment.'
      );
    } catch (errorResponseError) {
      logger.critical('Failed to send error response to user', {
        error: errorResponseError.message
      });
    }
  }
}

/**
 * Handle text messages with AI processing
 */
async function handleTextMessage(message, phoneNumber, displayName, messageId) {
  const textStartTime = Date.now();
  const messageText = sanitizeInput(message.text.body);
  
  logger.ai('ü§ñ Processing text message', {
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    textPreview: messageText.substring(0, 50) + '...',
    textLength: messageText.length,
    messageId
  });

  try {
    // Check if bot mode is enabled for this citizen
    logger.firebase('Checking citizen bot mode...');
    const botModeEnabled = await getCitizenBotMode(phoneNumber);
    logger.firebase(`Bot mode status: ${botModeEnabled ? 'enabled' : 'disabled'}`);
    
    // Analyze message intent and context
    logger.ai('Analyzing message intent and context...');
    const intentAnalysis = await analyzeIntent(messageText, phoneNumber);
    logger.ai('Intent analysis completed', {
      intent: intentAnalysis.intent,
      context: intentAnalysis.context,
      state: intentAnalysis.state,
      confidence: intentAnalysis.confidence
    });
    
    // Calculate ethical score
    logger.ai('Calculating ethical score...');
    const ethicalScore = await calculateEthicalScore(messageText);
    logger.ai(`Ethical score calculated: ${ethicalScore}/10`);
    
    // Detect language
    logger.ai('Detecting language...');
    const detectedLanguage = detectLanguage(messageText);
    logger.ai(`Language detected: ${detectedLanguage}`);

    // Save message to conversation log with sanitized data
    logger.firebase('Saving message to conversation log...');
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'text',
      content: messageText,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: intentAnalysis.intent,
      context: intentAnalysis.context,
      conversationState: intentAnalysis.state,
      language: detectedLanguage,
      ethicalScore,
      botModeEnabled,
      confidence: intentAnalysis.confidence
    }));

    // Update citizen's ethical score
    logger.firebase('Updating citizen ethical score...');
    await updateCitizenEthicalScore(phoneNumber, ethicalScore);

    // If bot mode is disabled, only log the message
    if (!botModeEnabled) {
      logger.warning(`üîï Bot mode disabled for ${phoneNumber.replace(/^91/, 'XXX-XXX-')}. Message logged only.`);
      await sendTextMessage(phoneNumber, 
        '‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡§æ ‡§Ü‡§π‡•á. ‡§∏‡§ß‡•ç‡§Ø‡§æ AI ‡§∏‡§π‡§æ‡§Ø‡•ç‡§Ø‡§ï ‡§®‡§ø‡§∑‡•ç‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§Ü‡§π‡•á.\n\nYour message has been logged. AI assistant is currently disabled.'
      );
      return;
    }

    // Process based on intent
    switch (intentAnalysis.intent) {
      case 'complaint':
        logger.complaint('üéØ Processing complaint flow...');
        await handleComplaintFlow(messageText, phoneNumber, displayName, intentAnalysis, detectedLanguage);
        break;
      case 'query':
        logger.ai('‚ùì Processing information query...');
        await handleQueryFlow(messageText, phoneNumber, displayName, intentAnalysis, detectedLanguage);
        break;
      case 'greeting':
        logger.ai('üëã Processing greeting...');
        await handleGreetingFlow(messageText, phoneNumber, displayName, intentAnalysis, detectedLanguage);
        break;
      case 'small_talk':
        logger.ai('üí¨ Processing small talk...');
        await handleSmallTalkFlow(messageText, phoneNumber, displayName, intentAnalysis, detectedLanguage);
        break;
      default:
        logger.ai('üîÑ Processing general conversation...');
        await handleGeneralConversation(messageText, phoneNumber, displayName, intentAnalysis, detectedLanguage);
    }

    const processingTime = Date.now() - textStartTime;
    logger.success(`Text message processed in ${processingTime}ms`, {
      intent: intentAnalysis.intent,
      language: detectedLanguage,
      ethicalScore
    });

  } catch (error) {
    const processingTime = Date.now() - textStartTime;
    logger.critical('üí• Error in text message handling', {
      error: error.message,
      stack: error.stack,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      messageId,
      processingTime
    });
    
    // Send error response to user
    const errorMessage = detectLanguage(messageText) === 'marathi' ? 
      '‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.' :
      'Sorry, there was an error processing your message. Please try again.';
    
    await sendTextMessage(phoneNumber, errorMessage);
  }
}

/**
 * Handle audio messages with transcription
 */
async function handleAudioMessage(message, phoneNumber, displayName, messageId) {
  const audioStartTime = Date.now();
  
  logger.ai('üéµ Processing audio message', { 
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    mediaId: message.audio.id,
    mimeType: message.audio.mime_type
  });

  let localAudioPath = null;

  try {
    const botModeEnabled = await getCitizenBotMode(phoneNumber);
    
    // Download and transcribe audio
    logger.whatsapp('Downloading audio file...');
    const mediaUrl = await getMediaUrl(message.audio.id);
    localAudioPath = await downloadAudioFile(mediaUrl, message.audio.id);
    
    logger.ai('Transcribing audio with Whisper...');
    const transcript = await transcribeAudio(localAudioPath);
    logger.ai('Audio transcription completed', { 
      transcriptPreview: transcript.substring(0, 100) + '...',
      transcriptLength: transcript.length
    });

    // Analyze transcript
    const intentAnalysis = await analyzeIntent(transcript, phoneNumber);
    const ethicalScore = await calculateEthicalScore(transcript);
    const detectedLanguage = detectLanguage(transcript);

    // Save message with transcript using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'audio',
      content: transcript,
      audioMetadata: {
        mediaId: message.audio.id,
        mimeType: message.audio.mime_type,
        transcriptionTime: Date.now() - audioStartTime
      },
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: intentAnalysis.intent,
      context: intentAnalysis.context,
      conversationState: intentAnalysis.state,
      language: detectedLanguage,
      ethicalScore,
      botModeEnabled
    }));

    await updateCitizenEthicalScore(phoneNumber, ethicalScore);

    if (!botModeEnabled) {
      logger.warning(`üîï Bot mode disabled for ${phoneNumber.replace(/^91/, 'XXX-XXX-')}. Audio message logged only.`);
      return;
    }

    // Process transcript based on intent
    if (intentAnalysis.intent === 'complaint') {
      await handleComplaintFlow(transcript, phoneNumber, displayName, intentAnalysis, detectedLanguage);
    } else {
      await handleGeneralConversation(transcript, phoneNumber, displayName, intentAnalysis, detectedLanguage);
    }

    const processingTime = Date.now() - audioStartTime;
    logger.success(`Audio message processed in ${processingTime}ms`);

  } catch (error) {
    const processingTime = Date.now() - audioStartTime;
    logger.critical('üí• Error processing audio message', { 
      error: error.message,
      stack: error.stack,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      processingTime
    });
    
    await sendTextMessage(phoneNumber, 
      '‡§ë‡§°‡§ø‡§ì ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§Æ‡§ú‡§ï‡•Ç‡§∞ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§™‡§æ‡§†‡§µ‡§æ.\n\nError processing audio. Please send a text message.'
    );
  } finally {
    // Clean up temporary audio file
    if (localAudioPath && fs.existsSync(localAudioPath)) {
      try {
        fs.unlinkSync(localAudioPath);
        logger.debug('üóëÔ∏è Temporary audio file cleaned up');
      } catch (cleanupError) {
        logger.warning('Failed to cleanup audio file', { 
          path: localAudioPath,
          error: cleanupError.message 
        });
      }
    }
  }
}

/**
 * Handle image messages with AI analysis - FIXED for undefined values
 */
async function handleImageMessage(message, phoneNumber, displayName, messageId) {
  const imageStartTime = Date.now();
  
  logger.ai('üñºÔ∏è Processing image message', { 
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    mediaId: message.image.id,
    hasCaption: !!message.image.caption
  });

  try {
    const botModeEnabled = await getCitizenBotMode(phoneNumber);
    
    // Download and upload image
    logger.whatsapp('Downloading and uploading image...');
    const mediaUrl = await getMediaUrl(message.image.id);
    const imageUrl = await downloadAndUploadImage(mediaUrl, message.image.id);
    
    // Analyze image content with AI
    logger.ai('Analyzing image content with AI...');
    const imageAnalysis = await analyzeImageContent(imageUrl);
    
    // Combine image analysis with caption if present
    const caption = message.image.caption || ''; // Handle undefined caption
    const fullContent = caption ? 
      `${caption}\n\nImage Analysis: ${imageAnalysis}` : 
      `Image Analysis: ${imageAnalysis}`;
    
    const intentAnalysis = await analyzeIntent(fullContent, phoneNumber);
    const ethicalScore = await calculateEthicalScore(fullContent);
    const detectedLanguage = detectLanguage(fullContent);

    // Save message with proper handling of undefined values using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'image',
      content: fullContent,
      imageUrl,
      imageMetadata: {
        mediaId: message.image.id,
        caption: caption || null, // Convert undefined to null
        hasCaption: !!message.image.caption,
        analysisTime: Date.now() - imageStartTime,
        fileSize: null // We don't have this info from WhatsApp
      },
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: intentAnalysis.intent,
      context: intentAnalysis.context,
      conversationState: intentAnalysis.state,
      language: detectedLanguage,
      ethicalScore,
      botModeEnabled
    }));

    await updateCitizenEthicalScore(phoneNumber, ethicalScore);

    if (!botModeEnabled) {
      logger.warning(`üîï Bot mode disabled for ${phoneNumber.replace(/^91/, 'XXX-XXX-')}. Image message logged only.`);
      return;
    }

    // Process image analysis
    if (intentAnalysis.intent === 'complaint') {
      await handleComplaintFlow(fullContent, phoneNumber, displayName, intentAnalysis, detectedLanguage, imageUrl);
    } else {
      await handleGeneralConversation(fullContent, phoneNumber, displayName, intentAnalysis, detectedLanguage);
    }

    const processingTime = Date.now() - imageStartTime;
    logger.success(`Image message processed in ${processingTime}ms`);

  } catch (error) {
    const processingTime = Date.now() - imageStartTime;
    logger.critical('üí• Error processing image message', { 
      error: error.message,
      stack: error.stack,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      processingTime
    });
    
    await sendTextMessage(phoneNumber,
      '‡§™‡•ç‡§∞‡§§‡§ø‡§Æ‡§æ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.\n\nError processing image. Please try again.'
    );
  }
}

/**
 * Handle location messages - FIXED to only work with WhatsApp location sharing
 */
async function handleLocationMessage(message, phoneNumber, displayName, messageId) {
  const locationStartTime = Date.now();
  const latitude = message.location.latitude;
  const longitude = message.location.longitude;
  const locationName = message.location.name || null;
  const locationAddress = message.location.address || null;
  
  logger.ai('üìç Processing WhatsApp location message', { 
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    latitude, 
    longitude,
    hasName: !!locationName,
    hasAddress: !!locationAddress
  });

  try {
    // Geocode location to get detailed address if not provided
    logger.firebase('Geocoding location coordinates...');
    const geocodedAddress = await geocodeAddress(latitude, longitude);
    const finalAddress = locationAddress || geocodedAddress;
    
    // Create proper location data object
    const locationData = {
      latitude,
      longitude,
      name: locationName,
      address: finalAddress,
      originalAddress: locationAddress,
      geocodedAddress: geocodedAddress,
      source: 'whatsapp_location',
      timestamp: new Date().toISOString()
    };
    
    // Save location message using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'location',
      content: `Location shared: ${finalAddress}`,
      location: locationData,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'location_sharing',
      context: 'location_provided',
      conversationState: 'location_received',
      ethicalScore: 9,
      botModeEnabled: true
    }));

    // Check for pending complaints that need location
    logger.firebase('Checking for pending complaints needing location...');
    const pendingComplaint = await getPendingComplaintForUser(phoneNumber);
    
    if (pendingComplaint) {
      logger.complaint('Completing complaint with WhatsApp location...');
      
      // Complete complaint registration with WhatsApp location
      const ticketId = await confirmComplaint(pendingComplaint.id, locationData);

      const language = detectLanguage(pendingComplaint.description);
      const successMessage = language === 'marathi' ?
        `‚úÖ ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡•Ä ‡§ó‡•á‡§≤‡•Ä!\n\nüé´ ‡§§‡§ø‡§ï‡•Ä‡§ü ID: ${ticketId}\nüìç ‡§∏‡•ç‡§•‡§æ‡§®: ${finalAddress}\nüèõÔ∏è ‡§µ‡§ø‡§≠‡§æ‡§ó: ${pendingComplaint.department}\n‚ö° ‡§™‡•ç‡§∞‡§æ‡§ß‡§æ‡§®‡•ç‡§Ø‡§§‡§æ: ${pendingComplaint.priority}\n\n‡§™‡•Ä‡§∏‡•Ä‡§è‡§Æ‡§∏‡•Ä ${pendingComplaint.estimatedResolutionTime} ‡§§‡§æ‡§∏‡§æ‡§Ç‡§§ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§æ‡§π‡•Ä ‡§ï‡§∞‡•á‡§≤.\n\n‡§Ü‡§™‡§≤‡•ç‡§Ø‡§æ ‡§∏‡§π‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§¨‡§¶‡•ç‡§¶‡§≤ ‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶! üôè` :
        `‚úÖ Your complaint has been registered successfully!\n\nüé´ Ticket ID: ${ticketId}\nüìç Location: ${finalAddress}\nüèõÔ∏è Department: ${pendingComplaint.department}\n‚ö° Priority: ${pendingComplaint.priority}\n\nPCMC will take action within ${pendingComplaint.estimatedResolutionTime} hours.\n\nThank you for your cooperation! üôè`;

      await sendTextMessage(phoneNumber, successMessage);
      logger.success('Complaint completed with WhatsApp location', {
        ticketId,
        complaintId: pendingComplaint.id,
        location: `${latitude}, ${longitude}`
      });
    } else {
      // General location acknowledgment
      const areaInfo = await getAreaSpecificInfo(latitude, longitude);
      const response = `üìç ‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ù‡§æ‡§≤‡•á: ${finalAddress}\n\n${areaInfo}\n\n‡§™‡•Ä‡§∏‡•Ä‡§è‡§Æ‡§∏‡•Ä ‡§Ü‡§ú ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ï‡§∂‡•Ä ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡•á?\n\nüìç Location received: ${finalAddress}\n\nHow can PCMC help you today?`;
      
      await sendTextMessage(phoneNumber, response);
      logger.ai('Location acknowledged with area info');
    }

    const processingTime = Date.now() - locationStartTime;
    logger.success(`Location message processed in ${processingTime}ms`);

  } catch (error) {
    const processingTime = Date.now() - locationStartTime;
    logger.critical('üí• Error processing location message', { 
      error: error.message,
      stack: error.stack,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      processingTime
    });
    
    await sendTextMessage(phoneNumber,
      '‡§∏‡•ç‡§•‡§æ‡§® ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.\n\nError processing location. Please try again.'
    );
  }
}

/**
 * Handle interactive button responses
 */
async function handleInteractiveMessage(message, phoneNumber, displayName, messageId) {
  const interactiveStartTime = Date.now();
  
  logger.ai('üîò Processing interactive message', { 
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    type: message.interactive.type
  });

  try {
    if (message.interactive.type === 'button_reply') {
      const buttonId = message.interactive.button_reply.id;
      const buttonTitle = message.interactive.button_reply.title;
      
      logger.ai('Button clicked', { buttonId, buttonTitle });

      // Save interaction using sanitized data
      await saveChatMessage(phoneNumber, sanitizeFirestoreData({
        messageId,
        sender: phoneNumber,
        senderName: displayName,
        receiver: 'pcmc_bot',
        messageType: 'interactive',
        content: `Button clicked: ${buttonTitle}`,
        interactiveData: { 
          type: 'button_reply',
          buttonId, 
          buttonTitle 
        },
        timestamp: admin.firestore.FieldValue.serverTimestamp(),
        intent: 'button_interaction',
        context: 'user_confirmation',
        conversationState: buttonId.includes('confirm') ? 'confirmed' : 'cancelled',
        ethicalScore: 9,
        botModeEnabled: true
      }));

      // Handle specific button actions
      if (buttonId.startsWith('confirm_complaint_')) {
        const complaintId = buttonId.replace('confirm_complaint_', '');
        logger.complaint('Processing complaint confirmation...');
        await handleComplaintConfirmation(complaintId, phoneNumber);
      } else if (buttonId.startsWith('cancel_complaint_')) {
        const complaintId = buttonId.replace('cancel_complaint_', '');
        logger.complaint('Processing complaint cancellation...');
        await handleComplaintCancellation(complaintId, phoneNumber);
      } else if (buttonId.startsWith('department_')) {
        const department = buttonId.replace('department_', '');
        logger.ai('Processing department selection...');
        await handleDepartmentSelection(department, phoneNumber);
      } else if (buttonId === 'share_location') {
        logger.ai('Processing location sharing request...');
        await handleLocationSharingRequest(phoneNumber);
      } else {
        logger.warning('Unknown button interaction', { buttonId });
        await sendTextMessage(phoneNumber, 
          '‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, ‡§π‡•á ‡§¨‡§ü‡§£ ‡§ì‡§≥‡§ñ‡§≤‡•á ‡§ó‡•á‡§≤‡•á ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.\n\nSorry, this button was not recognized. Please try again.'
        );
      }

    } else if (message.interactive.type === 'list_reply') {
      const listId = message.interactive.list_reply.id;
      const listTitle = message.interactive.list_reply.title;
      
      logger.ai('List item selected', { listId, listTitle });
      
      // Handle list selections
      await handleListSelection(listId, listTitle, phoneNumber, displayName);
    }

    const processingTime = Date.now() - interactiveStartTime;
    logger.success(`Interactive message processed in ${processingTime}ms`);

  } catch (error) {
    const processingTime = Date.now() - interactiveStartTime;
    logger.critical('üí• Error processing interactive message', { 
      error: error.message,
      stack: error.stack,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      processingTime
    });
    
    await sendTextMessage(phoneNumber,
      '‡§á‡§Ç‡§ü‡§∞‡•Ö‡§ï‡•ç‡§ü‡§ø‡§µ‡•ç‡§π ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä.\n\nError processing interactive message.'
    );
  }
}

/**
 * Handle document messages
 */
async function handleDocumentMessage(message, phoneNumber, displayName, messageId) {
  logger.ai('üìÑ Document message received', {
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    mediaId: message.document.id,
    filename: message.document.filename,
    mimeType: message.document.mime_type
  });

  try {
    // Save document message using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'document',
      content: `Document shared: ${message.document.filename || 'Untitled'}`,
      documentMetadata: {
        mediaId: message.document.id,
        filename: message.document.filename || null,
        mimeType: message.document.mime_type || null,
        caption: message.document.caption || null
      },
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'document_sharing',
      context: 'document_upload',
      conversationState: 'document_received',
      ethicalScore: 8,
      botModeEnabled: true
    }));

    const response = message.document.filename ?
      `üìÑ ‡§¶‡§∏‡•ç‡§§‡§ê‡§µ‡§ú ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ù‡§æ‡§≤‡§æ: ${message.document.filename}\n\n‡§Ü‡§Æ‡•ç‡§π‡•Ä ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§¶‡§∏‡•ç‡§§‡§ê‡§µ‡§ú ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡§æ ‡§Ü‡§π‡•á. PCMC ‡§ï‡§∞‡•ç‡§Æ‡§ö‡§æ‡§∞‡•Ä ‡§§‡•ç‡§Ø‡§æ‡§ö‡•á ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ ‡§ï‡§∞‡§§‡•Ä‡§≤.\n\nüìÑ Document received: ${message.document.filename}\n\nWe have logged your document. PCMC staff will review it.` :
      `üìÑ ‡§¶‡§∏‡•ç‡§§‡§ê‡§µ‡§ú ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ù‡§æ‡§≤‡§æ.\n\n‡§Ü‡§Æ‡•ç‡§π‡•Ä ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§¶‡§∏‡•ç‡§§‡§ê‡§µ‡§ú ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡§æ ‡§Ü‡§π‡•á.\n\nüìÑ Document received.\n\nWe have logged your document.`;

    await sendTextMessage(phoneNumber, response);

  } catch (error) {
    logger.critical('Error processing document message', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    
    await sendTextMessage(phoneNumber,
      '‡§¶‡§∏‡•ç‡§§‡§ê‡§µ‡§ú ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä.\n\nError processing document.'
    );
  }
}

/**
 * Handle video messages
 */
async function handleVideoMessage(message, phoneNumber, displayName, messageId) {
  logger.ai('üé• Video message received', {
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    mediaId: message.video.id,
    mimeType: message.video.mime_type
  });

  try {
    // Save video message using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'video',
      content: `Video shared${message.video.caption ? ': ' + message.video.caption : ''}`,
      videoMetadata: {
        mediaId: message.video.id,
        mimeType: message.video.mime_type || null,
        caption: message.video.caption || null
      },
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'media_sharing',
      context: 'video_upload',
      conversationState: 'video_received',
      ethicalScore: 8,
      botModeEnabled: true
    }));

    await sendTextMessage(phoneNumber, 
      'üé• ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ù‡§æ‡§≤‡§æ. ‡§Ü‡§Æ‡•ç‡§π‡•Ä ‡§§‡•Å‡§Æ‡§ö‡§æ ‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡§æ ‡§Ü‡§π‡•á.\n\nüé• Video received. We have logged your video.'
    );

  } catch (error) {
    logger.critical('Error processing video message', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    
    await sendTextMessage(phoneNumber,
      '‡§µ‡•ç‡§π‡§ø‡§°‡§ø‡§ì ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä.\n\nError processing video.'
    );
  }
}

/**
 * Handle sticker messages
 */
async function handleStickerMessage(message, phoneNumber, displayName, messageId) {
  logger.ai('üòÄ Sticker message received', {
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    mediaId: message.sticker.id
  });

  try {
    // Save sticker message using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'sticker',
      content: 'Sticker sent',
      stickerMetadata: {
        mediaId: message.sticker.id,
        animated: message.sticker.animated || false
      },
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'expression',
      context: 'sticker_sharing',
      conversationState: 'sticker_received',
      ethicalScore: 8,
      botModeEnabled: true
    }));

    await sendTextMessage(phoneNumber, 
      'üòä ‡§∏‡•ç‡§ü‡§ø‡§ï‡§∞ ‡§™‡§æ‡§π‡§ø‡§≤‡§æ! ‡§™‡•Ä‡§∏‡•Ä‡§è‡§Æ‡§∏‡•Ä ‡§Ü‡§ú ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ï‡§∂‡•Ä ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡•á?\n\nüòä Sticker received! How can PCMC help you today?'
    );

  } catch (error) {
    logger.critical('Error processing sticker message', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle contact messages
 */
async function handleContactMessage(message, phoneNumber, displayName, messageId) {
  logger.ai('üë• Contact message received', {
    phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
    contactCount: message.contacts.length
  });

  try {
    const contactNames = message.contacts.map(contact => 
      contact.name?.formatted_name || 'Unknown Contact'
    ).join(', ');

    // Save contact message using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId,
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'contacts',
      content: `Contacts shared: ${contactNames}`,
      contactsMetadata: {
        contactCount: message.contacts.length,
        contacts: message.contacts
      },
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'contact_sharing',
      context: 'contact_info',
      conversationState: 'contacts_received',
      ethicalScore: 8,
      botModeEnabled: true
    }));

    await sendTextMessage(phoneNumber, 
      `üë• ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ù‡§æ‡§≤‡•Ä: ${contactNames}\n\n‡§Ü‡§Æ‡•ç‡§π‡•Ä ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡•Ä ‡§Ü‡§π‡•á.\n\nüë• Contact information received: ${contactNames}\n\nWe have logged your contact information.`
    );

  } catch (error) {
    logger.critical('Error processing contact message', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Send unsupported message type response
 */
async function sendUnsupportedMessageResponse(phoneNumber, messageType) {
  const response = `‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, "${messageType}" ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞‡§ö‡§æ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§∏‡§Æ‡§∞‡•ç‡§•‡§ø‡§§ ‡§®‡§æ‡§π‡•Ä.\n\n‡§ï‡•É‡§™‡§Ø‡§æ ‡§ñ‡§æ‡§≤‡•Ä‡§≤ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∞ ‡§µ‡§æ‡§™‡§∞‡§æ:\n‚Ä¢ ‡§Æ‡§ú‡§ï‡•Ç‡§∞ ‡§∏‡§Ç‡§¶‡•á‡§∂\n‚Ä¢ ‡§ë‡§°‡§ø‡§ì ‡§∏‡§Ç‡§¶‡•á‡§∂\n‚Ä¢ ‡§™‡•ç‡§∞‡§§‡§ø‡§Æ‡§æ\n‚Ä¢ ‡§∏‡•ç‡§•‡§æ‡§®\n‚Ä¢ ‡§¶‡§∏‡•ç‡§§‡§ê‡§µ‡§ú\n\nSorry, "${messageType}" message type is not currently supported.\n\nPlease use:\n‚Ä¢ Text messages\n‚Ä¢ Audio messages\n‚Ä¢ Images\n‚Ä¢ Location\n‚Ä¢ Documents`;

  await sendTextMessage(phoneNumber, response);
}

/**
 * Handle complaint registration flow
 */
async function handleComplaintFlow(messageText, phoneNumber, displayName, intentAnalysis, language, imageUrl = null) {
  try {
    logger.complaint('üéØ Starting complaint flow...');
    
    // Check for duplicate complaints
    logger.firebase('Checking for duplicate complaints...');
    const duplicateCheck = await checkDuplicateComplaint(messageText, phoneNumber);
    
    if (duplicateCheck.isDuplicate) {
      const responseMessage = language === 'marathi' ? 
        `üîÑ ‡§Ø‡§æ ‡§µ‡§ø‡§∑‡§Ø‡§æ‡§µ‡§∞ ‡§Ü‡§ß‡•Ä‡§ö ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡•Ä ‡§Ü‡§π‡•á (‡§§‡§ø‡§ï‡•Ä‡§ü: ${duplicateCheck.ticketId}).\n\n‡§∏‡•ç‡§•‡§ø‡§§‡•Ä: ${duplicateCheck.status}\n‡§∏‡§Æ‡§æ‡§®‡§§‡§æ: ${Math.round(duplicateCheck.similarity * 100)}%\n\n‡§Ü‡§Æ‡•ç‡§π‡•Ä ‡§§‡•Å‡§Æ‡•ç‡§π‡§æ‡§≤‡§æ ‡§Ö‡§™‡§°‡•á‡§ü‡§ö‡•ç‡§Ø‡§æ ‡§Ø‡§æ‡§¶‡•Ä‡§§ ‡§ú‡•ã‡§°‡§≤‡•á ‡§Ü‡§π‡•á. üìã` :
        `üîÑ A complaint on this issue is already registered (Ticket: ${duplicateCheck.ticketId}).\n\nStatus: ${duplicateCheck.status}\nSimilarity: ${Math.round(duplicateCheck.similarity * 100)}%\n\nWe've added you to the updates list. üìã`;
      
      await sendTextMessage(phoneNumber, responseMessage);
      logger.complaint('Duplicate complaint detected and user notified', {
        similarityScore: duplicateCheck.similarity,
        existingTicket: duplicateCheck.ticketId
      });
      return;
    }

    // Create draft complaint
    logger.firebase('Creating draft complaint...');
    const draftComplaint = await createDraftComplaint(messageText, phoneNumber, intentAnalysis, imageUrl);
    
    // Send confirmation request with enhanced information
    logger.whatsapp('Sending complaint confirmation...');
    const confirmationText = language === 'marathi' ? 
      `üìù ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§£‡•Ä ‡§™‡•Å‡§∑‡•ç‡§ü‡•Ä\n\nüéØ ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞:\n"${messageText.substring(0, 200)}${messageText.length > 200 ? '...' : ''}"\n\nüèõÔ∏è ‡§µ‡§ø‡§≠‡§æ‡§ó: ${draftComplaint.department}\n‚ö° ‡§™‡•ç‡§∞‡§æ‡§ß‡§æ‡§®‡•ç‡§Ø‡§§‡§æ: ${getPriorityEmoji(draftComplaint.priority)} ${draftComplaint.priority.toUpperCase()}\nüìä ‡§∂‡•ç‡§∞‡•á‡§£‡•Ä: ${draftComplaint.category}\n‚è±Ô∏è ‡§Ö‡§™‡•á‡§ï‡•ç‡§∑‡§ø‡§§ ‡§®‡§ø‡§∞‡§æ‡§ï‡§∞‡§£: ${draftComplaint.estimatedResolutionTime} ‡§§‡§æ‡§∏\n\n‡§π‡•Ä ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ‡§Ø‡§ö‡•Ä ‡§Ü‡§π‡•á ‡§ï‡§æ?` :
      `üìù Complaint Registration Confirmation\n\nüéØ Your complaint:\n"${messageText.substring(0, 200)}${messageText.length > 200 ? '...' : ''}"\n\nüèõÔ∏è Department: ${draftComplaint.department}\n‚ö° Priority: ${getPriorityEmoji(draftComplaint.priority)} ${draftComplaint.priority.toUpperCase()}\nüìä Category: ${draftComplaint.category}\n‚è±Ô∏è Expected resolution: ${draftComplaint.estimatedResolutionTime} hours\n\nDo you want to register this complaint?`;

    const buttons = [
      {
        type: 'reply',
        reply: {
          id: `confirm_complaint_${draftComplaint.id}`,
          title: language === 'marathi' ? '‚úÖ ‡§π‡•ã‡§Ø, ‡§®‡•ã‡§Ç‡§¶‡§µ‡§æ' : '‚úÖ Yes, Register'
        }
      },
      {
        type: 'reply',
        reply: {
          id: `cancel_complaint_${draftComplaint.id}`,
          title: language === 'marathi' ? '‚ùå ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ' : '‚ùå Cancel'
        }
      }
    ];

    await sendQuickReply(phoneNumber, confirmationText, buttons);
    logger.success('Complaint confirmation sent successfully', {
      complaintId: draftComplaint.id,
      department: draftComplaint.department,
      priority: draftComplaint.priority
    });

  } catch (error) {
    logger.critical('üí• Error in complaint flow', { 
      error: error.message, 
      stack: error.stack,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    
    const errorMessage = language === 'marathi' ? 
      '‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡•á‡§§ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.' :
      'Error processing complaint. Please try again.';
    await sendTextMessage(phoneNumber, errorMessage);
  }
}

/**
 * Handle general conversations with AI
 */
async function handleGeneralConversation(messageText, phoneNumber, displayName, intentAnalysis, language) {
  try {
    logger.ai('üîÑ Starting general conversation handling...');
    
    // Get conversation context
    logger.firebase('Getting conversation context...');
    const conversationContext = await getConversationContext(phoneNumber, 5);
    
    // Process with AI
    logger.ai('Processing message with AI...');
    const aiResponse = await processMessageWithAI(
      messageText, 
      phoneNumber, 
      intentAnalysis, 
      conversationContext,
      language
    );

    // Check if AI suggests location-based service
    if (aiResponse.requiresLocation) {
      logger.whatsapp('Sending location request based on AI suggestion...');
      await sendLocationRequest(phoneNumber, aiResponse.locationPrompt);
      return;
    }

    // Send AI response
    logger.whatsapp('Sending AI response...');
    await sendTextMessage(phoneNumber, aiResponse.message);

    // Log bot response using sanitized data
    logger.firebase('Logging bot response...');
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId: generateTicketId(8),
      sender: 'pcmc_bot',
      senderName: 'PCMC Assistant',
      receiver: phoneNumber,
      messageType: 'text',
      content: aiResponse.message,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'response',
      context: intentAnalysis.context,
      conversationState: 'completed',
      language,
      ethicalScore: 10, // Bot messages are always ethical
      botModeEnabled: true,
      aiMetadata: {
        originalIntent: intentAnalysis.intent,
        processingTime: Date.now() - Date.now()
      }
    }));

    logger.success('General conversation completed successfully');

  } catch (error) {
    logger.critical('üí• Error in general conversation', { 
      error: error.message,
      stack: error.stack,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    
    const errorMessage = language === 'marathi' ? 
      '‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, ‡§Æ‡•Ä ‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§ ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.' :
      'Sorry, I cannot help right now. Please try again.';
    await sendTextMessage(phoneNumber, errorMessage);
  }
}

/**
 * Handle query flow with knowledge base
 */
async function handleQueryFlow(messageText, phoneNumber, displayName, intentAnalysis, language) {
  try {
    logger.ai('‚ùì Processing information query...');
    
    // Get conversation context for better responses
    const conversationContext = await getConversationContext(phoneNumber, 3);
    
    // Process with AI using knowledge base
    const aiResponse = await processMessageWithAI(
      messageText, 
      phoneNumber, 
      intentAnalysis, 
      conversationContext,
      language
    );

    await sendTextMessage(phoneNumber, aiResponse.message);

    // Log interaction using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId: generateTicketId(8),
      sender: 'pcmc_bot',
      senderName: 'PCMC Assistant',
      receiver: phoneNumber,
      messageType: 'text',
      content: aiResponse.message,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'query_response',
      context: intentAnalysis.context,
      conversationState: 'query_completed',
      language,
      ethicalScore: 10,
      botModeEnabled: true
    }));

    logger.success('Query processed successfully');

  } catch (error) {
    logger.critical('Error in query flow', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    
    const errorMessage = language === 'marathi' ? 
      '‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§Æ‡§ø‡§≥‡§µ‡§ø‡§§‡§æ‡§®‡§æ ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.' :
      'Error retrieving information. Please try again.';
    await sendTextMessage(phoneNumber, errorMessage);
  }
}

/**
 * Handle greeting flow
 */
async function handleGreetingFlow(messageText, phoneNumber, displayName, intentAnalysis, language) {
  try {
    logger.ai('üëã Processing greeting...');
    
    const greeting = language === 'marathi' ? 
      `üôè ‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞ ${displayName}!\n\n‡§™‡§ø‡§Ç‡§™‡§∞‡•Ä-‡§ö‡§ø‡§Ç‡§ö‡§µ‡§° ‡§Æ‡§π‡§æ‡§®‡§ó‡§∞‡§™‡§æ‡§≤‡§ø‡§ï‡•á‡§§ (PCMC) ‡§Ü‡§™‡§≤‡•á ‡§∏‡•ç‡§µ‡§æ‡§ó‡§§ ‡§Ü‡§π‡•á! üèõÔ∏è\n\n‡§Æ‡•Ä ‡§Ü‡§™‡§≤‡§æ AI ‡§∏‡§π‡§æ‡§Ø‡•ç‡§Ø‡§ï ‡§Ü‡§π‡•á. ‡§Æ‡•Ä ‡§ñ‡§æ‡§≤‡•Ä‡§≤ ‡§¨‡§æ‡§¨‡§§‡•Ä‡§§ ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡•ã:\n\n‚Ä¢ üìù ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞‡•Ä ‡§®‡•ã‡§Ç‡§¶‡§µ‡§£‡•á\n‚Ä¢ ‚ÑπÔ∏è PCMC ‡§∏‡•á‡§µ‡§æ‡§Ç‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä\n‚Ä¢ üìû ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï ‡§§‡§™‡§∂‡•Ä‡§≤\n‚Ä¢ üè¢ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø‡•Ä‡§® ‡§µ‡•á‡§≥‡§æ‡§™‡§§‡•ç‡§∞‡§ï\n‚Ä¢ üí∞ ‡§ï‡§∞ ‡§≠‡§∞‡§£‡§æ\n‚Ä¢ üìã ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞‡•á\n\n‡§Ü‡§ú ‡§Æ‡•Ä ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ï‡§∂‡•Ä ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡•ã?` :
      `üôè Hello ${displayName}!\n\nWelcome to Pimpri-Chinchwad Municipal Corporation (PCMC)! üèõÔ∏è\n\nI'm your AI assistant. I can help you with:\n\n‚Ä¢ üìù Register complaints\n‚Ä¢ ‚ÑπÔ∏è PCMC services information\n‚Ä¢ üìû Contact details\n‚Ä¢ üè¢ Office timings\n‚Ä¢ üí∞ Tax payments\n‚Ä¢ üìã Certificates\n\nHow can I help you today?`;

    await sendTextMessage(phoneNumber, greeting);

    // Log greeting interaction using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId: generateTicketId(8),
      sender: 'pcmc_bot',
      senderName: 'PCMC Assistant',
      receiver: phoneNumber,
      messageType: 'text',
      content: greeting,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'greeting_response',
      context: 'welcome',
      conversationState: 'greeted',
      language,
      ethicalScore: 10,
      botModeEnabled: true
    }));

    logger.success('Greeting processed successfully');

  } catch (error) {
    logger.critical('Error in greeting flow', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle small talk flow
 */
async function handleSmallTalkFlow(messageText, phoneNumber, displayName, intentAnalysis, language) {
  try {
    logger.ai('üí¨ Processing small talk...');
    
    // Get context for more natural responses
    const conversationContext = await getConversationContext(phoneNumber, 3);
    
    // Process with AI for natural conversation
    const aiResponse = await processMessageWithAI(
      messageText, 
      phoneNumber, 
      intentAnalysis, 
      conversationContext,
      language
    );

    await sendTextMessage(phoneNumber, aiResponse.message);

    // Log interaction using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId: generateTicketId(8),
      sender: 'pcmc_bot',
      senderName: 'PCMC Assistant',
      receiver: phoneNumber,
      messageType: 'text',
      content: aiResponse.message,
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'small_talk_response',
      context: intentAnalysis.context,
      conversationState: 'casual_chat',
      language,
      ethicalScore: 10,
      botModeEnabled: true
    }));

    logger.success('Small talk processed successfully');

  } catch (error) {
    logger.critical('Error in small talk flow', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle complaint confirmation - UPDATED to only request WhatsApp location
 */
async function handleComplaintConfirmation(complaintId, phoneNumber) {
  try {
    logger.complaint('Processing complaint confirmation...', { complaintId });
    
    const complaint = await getDraftComplaint(complaintId);
    
    if (!complaint) {
      await sendTextMessage(phoneNumber, 
        '‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§∏‡§æ‡§™‡§°‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.\n\nComplaint not found. Please try again.'
      );
      return;
    }

    const language = detectLanguage(complaint.description);
    
    // ONLY request WhatsApp location sharing - no text address option
    const locationMessage = language === 'marathi' ?
      `‚úÖ ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§™‡•Å‡§∑‡•ç‡§ü ‡§ï‡•á‡§≤‡•Ä!\n\nüìç ‡§Ü‡§§‡§æ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•á ‡§Ö‡§ö‡•Ç‡§ï ‡§∏‡•ç‡§•‡§æ‡§® ‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§æ:\n\n1Ô∏è‚É£ WhatsApp ‡§Æ‡§ß‡•ç‡§Ø‡•á üìé (attach) ‡§¨‡§ü‡§£‡§æ‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ\n2Ô∏è‚É£ "Location" ‡§®‡§ø‡§µ‡§°‡§æ\n3Ô∏è‚É£ "Send your current location" ‡§®‡§ø‡§µ‡§°‡§æ\n\n‡§ï‡§ø‡§Ç‡§µ‡§æ ‡§Æ‡•á‡§∏‡•á‡§ú ‡§¨‡•â‡§ï‡•ç‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á üìç ‡§Ü‡§Ø‡§ï‡•â‡§®‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ\n\n‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ï‡•ç‡§§ WhatsApp ‡§ö‡•á location feature ‡§µ‡§æ‡§™‡§∞‡§æ` :
      `‚úÖ Complaint confirmed!\n\nüìç Now please share your exact location:\n\n1Ô∏è‚É£ Click üìé (attach) button in WhatsApp\n2Ô∏è‚É£ Select "Location"\n3Ô∏è‚É£ Choose "Send your current location"\n\nOr click üìç icon in message box\n\n‚ö†Ô∏è Please only use WhatsApp's location feature`;

    await sendTextMessage(phoneNumber, locationMessage);
    
    logger.success('Complaint confirmation processed - location request sent', { complaintId });

  } catch (error) {
    logger.critical('Error confirming complaint', { 
      error: error.message, 
      complaintId, 
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle complaint cancellation
 */
async function handleComplaintCancellation(complaintId, phoneNumber) {
  try {
    logger.complaint('Processing complaint cancellation...', { complaintId });
    
    await cancelComplaint(complaintId);
    
    await sendTextMessage(phoneNumber,
      `‚ùå ‡§§‡§ï‡•ç‡§∞‡§æ‡§∞ ‡§∞‡§¶‡•ç‡§¶ ‡§ï‡•á‡§≤‡•Ä.\n\n‡§ï‡•ã‡§£‡§§‡•ç‡§Ø‡§æ‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡§æ‡§∏‡§æ‡§†‡•Ä ‡§Ü‡§Æ‡•ç‡§π‡•Ä ‡§á‡§•‡•á ‡§Ü‡§π‡•ã‡§§. ‡§™‡•Ä‡§∏‡•Ä‡§è‡§Æ‡§∏‡•Ä ‡§Ü‡§ú ‡§§‡•Å‡§Æ‡§ö‡•Ä ‡§ï‡§∂‡•Ä ‡§Æ‡§¶‡§§ ‡§ï‡§∞‡•Ç ‡§∂‡§ï‡§§‡•á?\n\n‚ùå Complaint cancelled.\n\nWe're here for any questions. How can PCMC help you today?`
    );
    
    logger.success('Complaint cancellation processed', { complaintId });

  } catch (error) {
    logger.critical('Error cancelling complaint', { 
      error: error.message, 
      complaintId, 
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle department selection
 */
async function handleDepartmentSelection(department, phoneNumber) {
  try {
    logger.ai('Processing department selection...', { department });
    
    const departmentInfo = getDepartmentInfo(department);
    
    if (departmentInfo) {
      const response = `üèõÔ∏è ${departmentInfo.name}\n\nüìû ‡§∏‡§Ç‡§™‡§∞‡•ç‡§ï: ${departmentInfo.contact}\nüìß ‡§à‡§Æ‡•á‡§≤: ${departmentInfo.email}\n‚è∞ ‡§µ‡•á‡§≥: ${departmentInfo.timings}\n\nüìù ‡§∏‡•á‡§µ‡§æ:\n${departmentInfo.services.map(service => `‚Ä¢ ${service}`).join('\n')}\n\n‡§Ø‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§æ‡§¨‡§æ‡§¨‡§§ ‡§ï‡§æ‡§π‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ü‡§π‡•á ‡§ï‡§æ?`;
      
      await sendTextMessage(phoneNumber, response);
    } else {
      await sendTextMessage(phoneNumber, 
        '‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, ‡§Ø‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó‡§æ‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡§æ‡§™‡§°‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä.\n\nSorry, information for this department was not found.'
      );
    }
    
  } catch (error) {
    logger.critical('Error processing department selection', { 
      error: error.message, 
      department,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle location sharing request - UPDATED with clearer instructions
 */
async function handleLocationSharingRequest(phoneNumber) {
  try {
    const message = `üìç ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡•Å‡§Æ‡§ö‡•á ‡§∏‡•ç‡§•‡§æ‡§® ‡§∂‡•á‡§Ö‡§∞ ‡§ï‡§∞‡§æ | Please share your location:\n\nüîπ WhatsApp ‡§Æ‡§ß‡•ç‡§Ø‡•á:\n1. üìé (attach) ‡§¨‡§ü‡§£‡§æ‡§µ‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§æ\n2. "Location" ‡§®‡§ø‡§µ‡§°‡§æ\n3. "Send your current location" ‡§®‡§ø‡§µ‡§°‡§æ\n\nüîπ In WhatsApp:\n1. Click üìé (attach) button\n2. Select "Location"\n3. Choose "Send your current location"\n\n‚ö†Ô∏è ‡§Æ‡§π‡§§‡•ç‡§µ‡§æ‡§ö‡•á: ‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡§ï‡•ç‡§§ WhatsApp ‡§ö‡•á location sharing feature ‡§µ‡§æ‡§™‡§∞‡§æ\n‚ö†Ô∏è Important: Please only use WhatsApp's location sharing feature`;

    await sendTextMessage(phoneNumber, message);
    
    logger.ai('Clear location sharing instructions sent');
    
  } catch (error) {
    logger.critical('Error handling location sharing request', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle list selection
 */
async function handleListSelection(listId, listTitle, phoneNumber, displayName) {
  try {
    logger.ai('Processing list selection...', { listId, listTitle });
    
    // Save list selection using sanitized data
    await saveChatMessage(phoneNumber, sanitizeFirestoreData({
      messageId: generateTicketId(8),
      sender: phoneNumber,
      senderName: displayName,
      receiver: 'pcmc_bot',
      messageType: 'interactive',
      content: `List item selected: ${listTitle}`,
      interactiveData: { 
        type: 'list_reply',
        listId, 
        listTitle 
      },
      timestamp: admin.firestore.FieldValue.serverTimestamp(),
      intent: 'list_selection',
      context: 'menu_navigation',
      conversationState: 'list_selected',
      ethicalScore: 9,
      botModeEnabled: true
    }));

    // Handle specific list selections
    if (listId.startsWith('service_')) {
      const service = listId.replace('service_', '');
      await handleServiceSelection(service, phoneNumber);
    } else if (listId.startsWith('department_')) {
      const department = listId.replace('department_', '');
      await handleDepartmentSelection(department, phoneNumber);
    } else {
      await sendTextMessage(phoneNumber, 
        `‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä "${listTitle}" ‡§®‡§ø‡§µ‡§°‡§≤‡•á ‡§Ü‡§π‡•á. ‡§Ö‡§ß‡§ø‡§ï ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä‡§∏‡§æ‡§†‡•Ä ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•ç‡§∞‡§§‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ï‡§∞‡§æ.\n\nYou selected "${listTitle}". Please wait for more information.`
      );
    }
    
  } catch (error) {
    logger.critical('Error processing list selection', { 
      error: error.message,
      listId,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle service selection
 */
// Continuing from handleServiceSelection function...

/**
 * Handle service selection
 */
async function handleServiceSelection(service, phoneNumber) {
  try {
    logger.ai('Processing service selection...', { service });
    
    const serviceInfo = getServiceInfo(service);
    
    if (serviceInfo) {
      const response = `üîß ${serviceInfo.name}\n\nüìã ‡§µ‡§∞‡•ç‡§£‡§®: ${serviceInfo.description}\nüèõÔ∏è ‡§µ‡§ø‡§≠‡§æ‡§ó: ${serviceInfo.department}\nüí∞ ‡§´‡•Ä: ${serviceInfo.fee}\nüìÑ ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡§æ‡§ó‡§¶‡§™‡§§‡•ç‡§∞‡•á:\n${serviceInfo.documents.map(doc => `‚Ä¢ ${doc}`).join('\n')}\n‚è±Ô∏è ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§µ‡•á‡§≥: ${serviceInfo.processingTime}\n\n‡§Ø‡§æ ‡§∏‡•á‡§µ‡•á‡§∏‡§æ‡§†‡•Ä ‡§Ö‡§∞‡•ç‡§ú ‡§ï‡§∞‡§æ‡§Ø‡§ö‡§æ ‡§Ü‡§π‡•á ‡§ï‡§æ?`;
      
      await sendTextMessage(phoneNumber, response);
    } else {
      await sendTextMessage(phoneNumber, 
        '‡§Æ‡§æ‡§´ ‡§ï‡§∞‡§æ, ‡§Ø‡§æ ‡§∏‡•á‡§µ‡•á‡§ö‡•Ä ‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§∏‡§æ‡§™‡§°‡§≤‡•Ä ‡§®‡§æ‡§π‡•Ä.\n\nSorry, information for this service was not found.'
      );
    }
    
  } catch (error) {
    logger.critical('Error processing service selection', { 
      error: error.message, 
      service,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Process message status updates
 */
async function processMessageStatus(body) {
  try {
    const statusData = body.entry[0].changes[0].value.statuses[0];
    const messageId = statusData.id;
    const status = statusData.status;
    const timestamp = statusData.timestamp;
    const recipientId = statusData.recipient_id;

    logger.whatsapp('üìä Message status update received', { 
      messageId, 
      status,
      timestamp: new Date(parseInt(timestamp) * 1000).toISOString(),
      recipient: recipientId.replace(/^91/, 'XXX-XXX-')
    });

    // Log different status types
    switch (status) {
      case 'sent':
        logger.whatsapp('‚úÖ Message sent successfully', { messageId });
        break;
      case 'delivered':
        logger.whatsapp('üì¨ Message delivered', { messageId });
        break;
      case 'read':
        logger.whatsapp('üëÅÔ∏è Message read by user', { messageId });
        break;
      case 'failed':
        logger.critical('‚ùå Message delivery failed', { 
          messageId,
          error: statusData.errors?.[0] || 'Unknown error'
        });
        break;
      default:
        logger.whatsapp(`üìä Unknown status: ${status}`, { messageId });
    }

    // Optional: Update message status in database
    await updateMessageStatus(messageId, status, timestamp);

  } catch (error) {
    logger.critical('üí• Error processing message status', {
      error: error.message,
      stack: error.stack,
      statusData: body.entry?.[0]?.changes?.[0]?.value?.statuses?.[0]
    });
  }
}

/**
 * Get pending complaint for user that needs location - UPDATED query
 */
async function getPendingComplaintForUser(phoneNumber) {
  try {
    logger.firebase('Checking for pending complaints needing location...', {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });

    const complaintsRef = admin.firestore().collection('complaints');
    const query = complaintsRef
      .where('createdBy', '==', phoneNumber)
      .where('status', '==', 'draft')
      .where('requiresLocationSharing', '==', true) // New field to track location requirement
      .orderBy('createdAt', 'desc')
      .limit(1);

    const snapshot = await query.get();
    
    if (!snapshot.empty) {
      const complaint = snapshot.docs[0].data();
      logger.firebase('Found pending complaint needing location', { 
        complaintId: complaint.id,
        department: complaint.department
      });
      return complaint;
    }

    logger.firebase('No pending complaints found requiring location');
    return null;
  } catch (error) {
    logger.critical('Error getting pending complaint', { 
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    return null;
  }
}

/**
 * Get draft complaint by ID
 */
async function getDraftComplaint(complaintId) {
  try {
    logger.firebase('Getting draft complaint', { complaintId });

    const complaintRef = admin.firestore().collection('complaints').doc(complaintId);
    const complaintDoc = await complaintRef.get();
    
    if (complaintDoc.exists) {
      const complaint = complaintDoc.data();
      logger.firebase('Draft complaint found', { 
        complaintId,
        status: complaint.status,
        department: complaint.department
      });
      return complaint;
    }

    logger.warning('Draft complaint not found', { complaintId });
    return null;
  } catch (error) {
    logger.critical('Error getting draft complaint', { 
      error: error.message,
      complaintId
    });
    return null;
  }
}

/**
 * Get area-specific information based on coordinates
 */
async function getAreaSpecificInfo(latitude, longitude) {
  try {
    logger.firebase('Getting area-specific information', { latitude, longitude });

    // Area detection based on coordinates for PCMC region
    const areas = {
      'pimpri': { 
        lat: 18.6298, lng: 73.8022, 
        info: '‡§™‡§ø‡§Ç‡§™‡§∞‡•Ä ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ - ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§∂‡§π‡§∞‡•Ä ‡§≠‡§æ‡§ó | Pimpri Area - Main Urban Zone',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 1-15 | Wards 1-15'
      },
      'chinchwad': { 
        lat: 18.6186, lng: 73.7937, 
        info: '‡§ö‡§ø‡§Ç‡§ö‡§µ‡§° ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ - ‡§î‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï ‡§≠‡§æ‡§ó | Chinchwad Area - Industrial Zone',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 16-30 | Wards 16-30'
      },
      'akurdi': { 
        lat: 18.6476, lng: 73.7693, 
        info: '‡§Ö‡§ï‡•Å‡§∞‡•ç‡§°‡•Ä ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ - ‡§®‡§ø‡§µ‡§æ‡§∏‡•Ä ‡§≠‡§æ‡§ó | Akurdi Area - Residential Zone',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 31-45 | Wards 31-45'
      },
      'bhosari': { 
        lat: 18.6268, lng: 73.8354, 
        info: '‡§≠‡•ã‡§∏‡§∞‡•Ä ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ - MIDC ‡§î‡§¶‡•ç‡§Ø‡•ã‡§ó‡§ø‡§ï ‡§≠‡§æ‡§ó | Bhosari Area - MIDC Industrial Zone',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 46-60 | Wards 46-60'
      },
      'wakad': { 
        lat: 18.5975, lng: 73.7553, 
        info: '‡§µ‡§æ‡§ï‡§° ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ - IT ‡§π‡§¨ | Wakad Area - IT Hub',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 61-75 | Wards 61-75'
      },
      'hinjewadi': { 
        lat: 18.5908, lng: 73.7329, 
        info: '‡§π‡§ø‡§Ç‡§ú‡•á‡§µ‡§æ‡§°‡•Ä ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ - ‡§§‡§Ç‡§§‡•ç‡§∞‡§ú‡•ç‡§û‡§æ‡§® ‡§™‡§æ‡§∞‡•ç‡§ï | Hinjawadi Area - Technology Park',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 76-90 | Wards 76-90'
      },
      'nigdi': {
        lat: 18.6583, lng: 73.7667,
        info: '‡§®‡§ø‡§ó‡§°‡•Ä ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ - ‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞‡§ø‡§ï ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ | Nigdi Area - Commercial Center',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 91-105 | Wards 91-105'
      },
      'pune_airport': {
        lat: 18.5821, lng: 73.9197,
        info: '‡§™‡•Å‡§£‡•á ‡§µ‡§ø‡§Æ‡§æ‡§®‡§§‡§≥ ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ | Pune Airport Area',
        wardInfo: '‡§µ‡•â‡§∞‡•ç‡§° 106-120 | Wards 106-120'
      }
    };

    let closestArea = 'general';
    let minDistance = Infinity;
    let areaDetails = null;

    for (const [areaName, areaData] of Object.entries(areas)) {
      const distance = Math.sqrt(
        Math.pow(latitude - areaData.lat, 2) + Math.pow(longitude - areaData.lng, 2)
      );
      
      if (distance < minDistance) {
        minDistance = distance;
        closestArea = areaName;
        areaDetails = areaData;
      }
    }

    if (minDistance < 0.05 && areaDetails) { // Within ~5km
      logger.firebase('Area identified', { area: closestArea, distance: minDistance });
      return `üìç ${areaDetails.info}\nüèõÔ∏è ${areaDetails.wardInfo}`;
    }

    return 'üìç PCMC ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ | PCMC Area\nüèõÔ∏è ‡§™‡§ø‡§Ç‡§™‡§∞‡•Ä-‡§ö‡§ø‡§Ç‡§ö‡§µ‡§° ‡§Æ‡§π‡§æ‡§®‡§ó‡§∞‡§™‡§æ‡§≤‡§ø‡§ï‡§æ';
  } catch (error) {
    logger.critical('Error getting area info', { error: error.message });
    return 'üìç PCMC ‡§ï‡•ç‡§∑‡•á‡§§‡•ç‡§∞ | PCMC Area';
  }
}

/**
 * Get priority emoji based on priority level
 */
function getPriorityEmoji(priority) {
  const emojis = {
    'emergency': 'üö®',
    'high': 'üî¥',
    'medium': 'üü°',
    'low': 'üü¢'
  };
  return emojis[priority] || 'üü°';
}

/**
 * Get department information
 */
function getDepartmentInfo(department) {
  const departments = {
    'water_supply': {
      name: '‡§™‡§æ‡§£‡•Ä‡§™‡•Å‡§∞‡§µ‡§†‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó | Water Supply Department',
      contact: '020-27475201',
      email: 'water@pcmcindia.gov.in',
      timings: '‡§∏‡§ï‡§æ‡§≥‡•Ä 10 ‡§§‡•á ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ‡§ï‡§æ‡§≥‡•Ä 5:30 | 10 AM to 5:30 PM',
      services: [
        '‡§®‡§µ‡•Ä‡§® ‡§™‡§æ‡§£‡•Ä ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® | New water connections',
        '‡§Æ‡•Ä‡§ü‡§∞ ‡§¨‡§∏‡§µ‡§£‡•á | Meter installations', 
        '‡§™‡§æ‡§£‡•Ä ‡§ó‡•Å‡§£‡§µ‡§§‡•ç‡§§‡§æ ‡§§‡§™‡§æ‡§∏‡§£‡•Ä | Water quality testing',
        '‡§ó‡§≥‡§§‡•Ä ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä | Leak repairs',
        '‡§¨‡§ø‡§≤ ‡§≠‡§∞‡§£‡§æ | Bill payments'
      ]
    },
    'waste_management': {
      name: '‡§ò‡§®‡§ï‡§ö‡§∞‡§æ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§µ‡§ø‡§≠‡§æ‡§ó | Waste Management Department',
      contact: '020-27475202',
      email: 'waste@pcmcindia.gov.in',
      timings: '‡§∏‡§ï‡§æ‡§≥‡•Ä 6 ‡§§‡•á ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ‡§ï‡§æ‡§≥‡•Ä 8 | 6 AM to 8 PM',
      services: [
        '‡§ò‡§∞‡•ã‡§ò‡§∞‡•Ä ‡§ï‡§ö‡§∞‡§æ ‡§∏‡§Ç‡§ï‡§≤‡§® | Door-to-door collection',
        '‡§ï‡§ö‡§∞‡§æ ‡§µ‡§ø‡§≠‡§ï‡•ç‡§§‡•Ä‡§ï‡§∞‡§£ | Waste segregation',
        '‡§∞‡§∏‡•ç‡§§‡§æ ‡§∏‡§æ‡§´‡§∏‡§´‡§æ‡§à | Street cleaning',
        '‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§∂‡•å‡§ö‡§æ‡§≤‡§Ø | Public toilets',
        '‡§ï‡§ö‡§∞‡§æ ‡§™‡•ç‡§∞‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§ï‡•á‡§Ç‡§¶‡•ç‡§∞ | Waste processing centers'
      ]
    },
    'roads_infrastructure': {
      name: '‡§∞‡§∏‡•ç‡§§‡•á ‡§Ü‡§£‡§ø ‡§™‡§æ‡§Ø‡§æ‡§≠‡•Ç‡§§ ‡§∏‡•Å‡§µ‡§ø‡§ß‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó | Roads & Infrastructure Department',
      contact: '020-27475203',
      email: 'roads@pcmcindia.gov.in',
      timings: '‡§∏‡§ï‡§æ‡§≥‡•Ä 10 ‡§§‡•á ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ‡§ï‡§æ‡§≥‡•Ä 5:30 | 10 AM to 5:30 PM',
      services: [
        '‡§∞‡§∏‡•ç‡§§‡§æ ‡§¨‡§æ‡§Ç‡§ß‡§ï‡§æ‡§Æ | Road construction',
        '‡§∞‡§∏‡•ç‡§§‡§æ ‡§¶‡•Å‡§∞‡•Å‡§∏‡•ç‡§§‡•Ä | Road repairs',
        '‡§∞‡§∏‡•ç‡§§‡§æ ‡§¶‡§ø‡§µ‡•á | Street lighting',
        '‡§µ‡§æ‡§π‡§§‡•Ç‡§ï ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® | Traffic management',
        '‡§´‡•Å‡§ü‡§™‡§æ‡§• ‡§µ ‡§™‡•Å‡§≤ | Footpaths & bridges'
      ]
    },
    'health_sanitation': {
      name: '‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§Ü‡§£‡§ø ‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§§‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó | Health & Sanitation Department',
      contact: '020-27475204',
      email: 'health@pcmcindia.gov.in',
      timings: '‡§∏‡§ï‡§æ‡§≥‡•Ä 8 ‡§§‡•á ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ‡§ï‡§æ‡§≥‡•Ä 6 | 8 AM to 6 PM',
      services: [
        '‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï ‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§∏‡•á‡§µ‡§æ | Primary healthcare',
        '‡§≤‡§∏‡•Ä‡§ï‡§∞‡§£ ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§ï‡•ç‡§∞‡§Æ | Vaccination programs',
        '‡§∞‡•ã‡§ó ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ | Disease control',
        '‡§∏‡•ç‡§µ‡§ö‡•ç‡§õ‡§§‡§æ ‡§®‡§ø‡§∞‡•Ä‡§ï‡•ç‡§∑‡§£ | Sanitation inspection',
        '‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§∂‡§ø‡§ï‡•ç‡§∑‡§£ | Health education'
      ]
    },
    'building_planning': {
      name: '‡§á‡§Æ‡§æ‡§∞‡§§ ‡§Ü‡§£‡§ø ‡§®‡§ó‡§∞‡§∞‡§ö‡§®‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó | Building & Town Planning Department',
      contact: '020-27475205',
      email: 'planning@pcmcindia.gov.in',
      timings: '‡§∏‡§ï‡§æ‡§≥‡•Ä 10 ‡§§‡•á ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ‡§ï‡§æ‡§≥‡•Ä 5:30 | 10 AM to 5:30 PM',
      services: [
        '‡§á‡§Æ‡§æ‡§∞‡§§ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä | Building permissions',
        '‡§®‡§ï‡§æ‡§∂‡§æ ‡§Æ‡§Ç‡§ú‡•Å‡§∞‡•Ä | Plan approvals',
        '‡§µ‡§ø‡§ï‡§æ‡§∏ ‡§®‡§ø‡§Ø‡§Ç‡§§‡•ç‡§∞‡§£ | Development control',
        '‡§®‡§ó‡§∞ ‡§®‡§ø‡§Ø‡•ã‡§ú‡§® | Town planning',
        '‡§Ö‡§§‡§ø‡§ï‡•ç‡§∞‡§Æ‡§£ ‡§ï‡§æ‡§¢‡§£‡•á | Encroachment removal'
      ]
    },
    'property_tax': {
      name: '‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡§æ ‡§ï‡§∞ ‡§µ‡§ø‡§≠‡§æ‡§ó | Property Tax Department',
      contact: '020-27475206',
      email: 'tax@pcmcindia.gov.in',
      timings: '‡§∏‡§ï‡§æ‡§≥‡•Ä 10 ‡§§‡•á ‡§∏‡§Ç‡§ß‡•ç‡§Ø‡§æ‡§ï‡§æ‡§≥‡•Ä 5:30 | 10 AM to 5:30 PM',
      services: [
        '‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡§æ ‡§ï‡§∞ ‡§Æ‡•Ç‡§≤‡•ç‡§Ø‡§æ‡§Ç‡§ï‡§® | Property tax assessment',
        '‡§ï‡§∞ ‡§≠‡§∞‡§£‡§æ | Tax payments',
        '‡§ï‡§∞ ‡§∏‡•Ç‡§ü | Tax exemptions',
        '‡§ë‡§®‡§≤‡§æ‡§á‡§® ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü | Online payments',
        '‡§Æ‡§æ‡§≤‡§Æ‡§§‡•ç‡§§‡§æ ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä | Property registration'
      ]
    }
  };

  return departments[department] || null;
}

/**
 * Get service information
 */
function getServiceInfo(service) {
  const services = {
    'birth_certificate': {
      name: '‡§ú‡§®‡•ç‡§Æ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ | Birth Certificate',
      description: '‡§®‡§µ‡§ú‡§æ‡§§ ‡§¨‡§æ‡§≥‡§æ‡§ö‡•á ‡§ú‡§®‡•ç‡§Æ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ | Birth certificate for newborn',
      department: '‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§µ‡§ø‡§≠‡§æ‡§ó | Health Department',
      fee: '‚Çπ50',
      documents: [
        '‡§π‡•â‡§∏‡•ç‡§™‡§ø‡§ü‡§≤ ‡§ú‡§®‡•ç‡§Æ ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ | Hospital birth certificate',
        '‡§™‡§æ‡§≤‡§ï‡§æ‡§Ç‡§ö‡•Ä ‡§ì‡§≥‡§ñ‡§™‡§§‡•ç‡§∞‡•á | Parent ID proofs',
        '‡§™‡§§‡•ç‡§§‡§æ ‡§™‡•Å‡§∞‡§æ‡§µ‡§æ | Address proof',
        '‡§Ü‡§ß‡§æ‡§∞ ‡§ï‡§æ‡§∞‡•ç‡§° | Aadhaar Card'
      ],
      processingTime: '7 ‡§¶‡§ø‡§µ‡§∏ | 7 days'
    },
    'death_certificate': {
      name: '‡§Æ‡•É‡§§‡•ç‡§Ø‡•Ç ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ | Death Certificate',
      description: '‡§µ‡•ç‡§Ø‡§ï‡•ç‡§§‡•Ä‡§ö‡•á ‡§Æ‡•É‡§§‡•ç‡§Ø‡•Ç ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ | Death certificate for individual',
      department: '‡§Ü‡§∞‡•ã‡§ó‡•ç‡§Ø ‡§µ‡§ø‡§≠‡§æ‡§ó | Health Department',
      fee: '‚Çπ50',
      documents: [
        '‡§µ‡•à‡§¶‡•ç‡§Ø‡§ï‡•Ä‡§Ø ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ | Medical certificate',
        '‡§ï‡•Å‡§ü‡•Å‡§Ç‡§¨ ‡§∏‡§¶‡§∏‡•ç‡§Ø‡§æ‡§ö‡•Ä ‡§ì‡§≥‡§ñ‡§™‡§§‡•ç‡§∞ | Family member ID proof',
        '‡§™‡§§‡•ç‡§§‡§æ ‡§™‡•Å‡§∞‡§æ‡§µ‡§æ | Address proof'
      ],
      processingTime: '3 ‡§¶‡§ø‡§µ‡§∏ | 3 days'
    },
    'trade_license': {
      name: '‡§µ‡•ç‡§Ø‡§æ‡§™‡§æ‡§∞ ‡§™‡§∞‡§µ‡§æ‡§®‡§æ | Trade License',
      description: '‡§µ‡•ç‡§Ø‡§µ‡§∏‡§æ‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä ‡§™‡§∞‡§µ‡§æ‡§®‡§æ | License for business',
      department: '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§® | General Administration',
      fee: '‚Çπ500 - ‚Çπ5000',
      documents: [
        '‡§¶‡•Å‡§ï‡§æ‡§® ‡§ï‡§∞‡§æ‡§∞ | Shop agreement',
        '‡§ì‡§≥‡§ñ‡§™‡§§‡•ç‡§∞ | ID proof',
        'NOC ‡§Ü‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§Ö‡§∏‡§≤‡•ç‡§Ø‡§æ‡§∏ | NOC if required',
        '‡§™‡§§‡•ç‡§§‡§æ ‡§™‡•Å‡§∞‡§æ‡§µ‡§æ | Address proof'
      ],
      processingTime: '15 ‡§¶‡§ø‡§µ‡§∏ | 15 days'
    },
    'water_connection': {
      name: '‡§™‡§æ‡§£‡•Ä ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§® | Water Connection',
      description: '‡§®‡§µ‡•Ä‡§® ‡§™‡§æ‡§£‡•Ä ‡§ï‡§®‡•á‡§ï‡•ç‡§∂‡§®‡§∏‡§æ‡§†‡•Ä ‡§Ö‡§∞‡•ç‡§ú | Application for new water connection',
      department: '‡§™‡§æ‡§£‡•Ä‡§™‡•Å‡§∞‡§µ‡§†‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó | Water Supply Department',
      fee: '‚Çπ2000 - ‚Çπ10000',
      documents: [
        '‡§Æ‡§æ‡§≤‡§ï‡•Ä ‡§π‡§ï‡•ç‡§ï‡§æ‡§ö‡•á ‡§ï‡§æ‡§ó‡§¶‡§™‡§§‡•ç‡§∞ | Ownership documents',
        '‡§ì‡§≥‡§ñ‡§™‡§§‡•ç‡§∞ | ID proof',
        '‡§™‡§§‡•ç‡§§‡§æ ‡§™‡•Å‡§∞‡§æ‡§µ‡§æ | Address proof',
        '‡§∏‡§æ‡§á‡§ü ‡§™‡•ç‡§≤‡•Ö‡§® | Site plan'
      ],
      processingTime: '21 ‡§¶‡§ø‡§µ‡§∏ | 21 days'
    },
    'building_permit': {
      name: '‡§á‡§Æ‡§æ‡§∞‡§§ ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä | Building Permit',
      description: '‡§¨‡§æ‡§Ç‡§ß‡§ï‡§æ‡§Æ‡§æ‡§∏‡§æ‡§†‡•Ä ‡§™‡§∞‡§µ‡§æ‡§®‡§ó‡•Ä | Permission for construction',
      department: '‡§á‡§Æ‡§æ‡§∞‡§§ ‡§Ü‡§£‡§ø ‡§®‡§ó‡§∞‡§∞‡§ö‡§®‡§æ ‡§µ‡§ø‡§≠‡§æ‡§ó | Building & Planning Department',
      fee: '‚Çπ5000 - ‚Çπ50000',
      documents: [
        '‡§®‡§ï‡§æ‡§∂‡•á (7 ‡§™‡•ç‡§∞‡§§‡•Ä) | Plans (7 copies)',
        '‡§ú‡§Æ‡•Ä‡§® ‡§ï‡§æ‡§ó‡§¶‡§™‡§§‡•ç‡§∞ | Land documents',
        'NOC ‡§ó‡§∞‡§ú‡•á‡§®‡•Å‡§∏‡§æ‡§∞ | NOC as required',
        '‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡•á ‡§®‡§Ç‡§¨‡§∞ | Survey number'
      ],
      processingTime: '45 ‡§¶‡§ø‡§µ‡§∏ | 45 days'
    },
    'marriage_certificate': {
      name: '‡§µ‡§ø‡§µ‡§æ‡§π ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä | Marriage Registration',
      description: '‡§µ‡§ø‡§µ‡§æ‡§π ‡§®‡•ã‡§Ç‡§¶‡§£‡•Ä ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡§™‡§§‡•ç‡§∞ | Marriage registration certificate',
      department: '‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡§æ‡§∏‡§® | General Administration',
      fee: '‚Çπ100',
      documents: [
        '‡§µ‡§ø‡§µ‡§æ‡§π ‡§®‡§ø‡§Æ‡§Ç‡§§‡•ç‡§∞‡§£ ‡§™‡§§‡•ç‡§∞ | Wedding invitation',
        '‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§™‡§ï‡•ç‡§∑‡§æ‡§Ç‡§ö‡•Ä ‡§ì‡§≥‡§ñ‡§™‡§§‡•ç‡§∞‡•á | ID proofs of both parties',
        '‡§µ‡§Ø ‡§™‡•Å‡§∞‡§æ‡§µ‡§æ | Age proof',
        '2 ‡§∏‡§æ‡§ï‡•ç‡§∑‡•Ä‡§¶‡§æ‡§∞ | 2 witnesses'
      ],
      processingTime: '10 ‡§¶‡§ø‡§µ‡§∏ | 10 days'
    }
  };

  return services[service] || null;
}

/**
 * Get estimated resolution time based on department and priority
 */
function getEstimatedResolutionTime(department, priority) {
  const baseTimes = {
    'Water Supply': 24,
    'Waste Management': 48,
    'Roads & Infrastructure': 72,
    'Health & Sanitation': 24,
    'Building & Planning': 168, // 1 week
    'Electricity': 12,
    'Parks & Recreation': 48,
    'Traffic & Transport': 24,
    'Property Tax': 72,
    'General Administration': 48
  };

  const priorityMultipliers = {
    'emergency': 0.25,
    'high': 0.5,
    'medium': 1.0,
    'low': 1.5
  };

  const baseTime = baseTimes[department] || 48;
  const multiplier = priorityMultipliers[priority] || 1.0;
  
  return Math.ceil(baseTime * multiplier);
}

/**
 * Update message status in database (optional feature)
 */
async function updateMessageStatus(messageId, status, timestamp) {
  try {
    // Optional: Store message delivery status for analytics
    logger.debug('Message status tracking', {
      messageId,
      status,
      timestamp: new Date(parseInt(timestamp) * 1000).toISOString()
    });
    
    // Example implementation for message status tracking:
    /*
    const statusRef = admin.firestore().collection('message_status').doc(messageId);
    await statusRef.set(sanitizeFirestoreData({
      messageId,
      status,
      timestamp: new Date(parseInt(timestamp) * 1000),
      updatedAt: admin.firestore.FieldValue.serverTimestamp()
    }), { merge: true });
    */
    
  } catch (error) {
    logger.warning('Error updating message status', {
      error: error.message,
      messageId,
      status
    });
  }
}

/**
 * Send typing indicator (if supported by WhatsApp Business API)
 */
async function sendTypingIndicator(phoneNumber) {
  try {
    // Note: Typing indicators may not be supported in all WhatsApp Business API versions
    logger.debug('Sending typing indicator', {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    
    // Implementation would depend on WhatsApp Business API capabilities
    // This is a placeholder for future enhancement
    
  } catch (error) {
    logger.debug('Typing indicator not supported or failed', {
      error: error.message
    });
  }
}

/**
 * Handle system maintenance mode
 */
async function handleMaintenanceMode(phoneNumber) {
  try {
    const maintenanceMessage = `üîß ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§Æ‡•á‡§Ç‡§ü‡•á‡§®‡§®‡•ç‡§∏ | System Maintenance\n\n‡§∏‡§ß‡•ç‡§Ø‡§æ ‡§Ü‡§Æ‡§ö‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç‡§ü‡•á‡§®‡§®‡•ç‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§Ü‡§π‡•á. ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡•ã‡§°‡•ç‡§Ø‡§æ ‡§µ‡•á‡§≥‡§æ‡§®‡•á ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.\n\n‡§Ö‡§§‡•ç‡§Ø‡§æ‡§µ‡§∂‡•ç‡§Ø‡§ï ‡§ï‡§æ‡§Æ‡§æ‡§∏‡§æ‡§†‡•Ä: 020-27475000\n\nOur service is currently under maintenance. Please try again later.\n\nFor emergency: 020-27475000`;

    await sendTextMessage(phoneNumber, maintenanceMessage);
    
    logger.warning('Maintenance mode response sent', {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
    
  } catch (error) {
    logger.critical('Error sending maintenance mode message', {
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Handle rate limiting for users
 */
async function handleRateLimit(phoneNumber, messageType) {
  try {
    const rateLimitMessage = `‚ö†Ô∏è ‡§¶‡§∞ ‡§Æ‡§∞‡•ç‡§Ø‡§æ‡§¶‡§æ | Rate Limit\n\n‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§ñ‡•Ç‡§™ ‡§ú‡§æ‡§∏‡•ç‡§§ ‡§∏‡§Ç‡§¶‡•á‡§∂ ‡§™‡§æ‡§†‡§µ‡§≤‡•á ‡§Ü‡§π‡•á‡§§. ‡§ï‡•É‡§™‡§Ø‡§æ 15 ‡§Æ‡§ø‡§®‡§ø‡§ü‡§æ‡§Ç‡§®‡•Ä ‡§™‡•Å‡§®‡•ç‡§π‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§ï‡§∞‡§æ.\n\nYou've sent too many messages. Please try again in 15 minutes.\n\n‡§Ö‡§§‡•ç‡§Ø‡§æ‡§µ‡§∂‡•ç‡§Ø‡§ï: 020-27475000`;

    await sendTextMessage(phoneNumber, rateLimitMessage);
    
    logger.warning('Rate limit response sent', {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      messageType
    });
    
  } catch (error) {
    logger.critical('Error sending rate limit message', {
      error: error.message,
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-')
    });
  }
}

/**
 * Log performance metrics
 */
function logPerformanceMetrics(operation, startTime, additionalData = {}) {
  const endTime = Date.now();
  const duration = endTime - startTime;
  
  logger.debug(`‚ö° Performance: ${operation}`, {
    operation,
    duration: `${duration}ms`,
    timestamp: new Date().toISOString(),
    ...additionalData
  });
  
  // Log slow operations
  if (duration > 5000) { // 5 seconds
    logger.warning(`üêå Slow operation detected: ${operation}`, {
      operation,
      duration: `${duration}ms`,
      ...additionalData
    });
  }
  
  return duration;
}

/**
 * Clean up temporary resources
 */
function cleanupTempResources(tempFiles = []) {
  tempFiles.forEach(filePath => {
    try {
      if (fs.existsSync(filePath)) {
        fs.unlinkSync(filePath);
        logger.debug('üóëÔ∏è Temporary file cleaned up', { filePath });
      }
    } catch (error) {
      logger.warning('Failed to cleanup temporary file', {
        filePath,
        error: error.message
      });
    }
  });
}

/**
 * Generate comprehensive error report
 */
function generateErrorReport(error, context = {}) {
  return {
    timestamp: new Date().toISOString(),
    error: {
      message: error.message,
      stack: error.stack,
      name: error.name
    },
    context,
    system: {
      nodeVersion: process.version,
      platform: process.platform,
      memory: process.memoryUsage(),
      uptime: process.uptime()
    },
    environment: process.env.NODE_ENV || 'development'
  };
}

/**
 * Handle webhook verification for development/testing
 */
function handleWebhookVerification(req, res) {
  const mode = req.query['hub.mode'];
  const token = req.query['hub.verify_token'];
  const challenge = req.query['hub.challenge'];

  logger.webhook('üîê Webhook verification request', {
    mode,
    tokenProvided: !!token,
    challengeProvided: !!challenge,
    ip: req.ip,
    userAgent: req.get('User-Agent')
  });

  if (mode === 'subscribe' && token === process.env.VERIFY_TOKEN) {
    logger.success('‚úÖ Webhook verification successful');
    return res.status(200).send(challenge);
  } else {
    logger.warning('‚ùå Webhook verification failed', {
      mode,
      tokenMatch: token === process.env.VERIFY_TOKEN,
      expectedToken: process.env.VERIFY_TOKEN ? 'configured' : 'missing'
    });
    return res.sendStatus(403);
  }
}

/**
 * Emergency fallback handler
 */
async function handleEmergencyFallback(phoneNumber, error) {
  try {
    const emergencyMessage = `üö® ‡§Ü‡§™‡§æ‡§§‡§ï‡§æ‡§≤‡•Ä‡§® ‡§∏‡•á‡§µ‡§æ | Emergency Service\n\n‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§§‡§æ‡§Ç‡§§‡•ç‡§∞‡§ø‡§ï ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§Ü‡§≤‡•Ä ‡§Ü‡§π‡•á.\n\n‡§§‡§æ‡§§‡§°‡•Ä‡§ö‡•ç‡§Ø‡§æ ‡§Æ‡§¶‡§§‡•Ä‡§∏‡§æ‡§†‡•Ä:\nüìû 020-27475000 (PCMC Control Room)\nüìû 100 (Police)\nüìû 101 (Fire)\nüìû 108 (Ambulance)\n\nSystem technical issue occurred.\n\nFor immediate help:\nüìû 020-27475000 (PCMC Control Room)`;

    await sendTextMessage(phoneNumber, emergencyMessage);
    
    logger.critical('Emergency fallback message sent', {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      originalError: error.message
    });
    
  } catch (fallbackError) {
    logger.critical('Emergency fallback also failed', {
      phoneNumber: phoneNumber.replace(/^91/, 'XXX-XXX-'),
      originalError: error.message,
      fallbackError: fallbackError.message
    });
  }
}

/**
 * Download audio file from WhatsApp media URL
 */


// Export all functions
module.exports = {
  handleWebhook,
  handleWebhookVerification,
  processIncomingMessage,
  handleTextMessage,
  handleAudioMessage,
  handleImageMessage,
  handleLocationMessage,
  handleInteractiveMessage,
  handleDocumentMessage,
  handleVideoMessage,
  handleStickerMessage,
  handleContactMessage,
  sendUnsupportedMessageResponse,
  handleComplaintFlow,
  handleGeneralConversation,
  handleQueryFlow,
  handleGreetingFlow,
  handleSmallTalkFlow,
  handleComplaintConfirmation,
  handleComplaintCancellation,
  handleDepartmentSelection,
  handleLocationSharingRequest,
  handleListSelection,
  handleServiceSelection,
  processMessageStatus,
  
  // Utility functions
  getPendingComplaintForUser,
  getDraftComplaint,
  getAreaSpecificInfo,
  getPriorityEmoji,
  getDepartmentInfo,
  getServiceInfo,
  getEstimatedResolutionTime,
  updateMessageStatus,
  sendTypingIndicator,
  handleMaintenanceMode,
  handleRateLimit,
  logPerformanceMetrics,
  cleanupTempResources,
  generateErrorReport,
  handleEmergencyFallback,
  downloadAudioFile
};